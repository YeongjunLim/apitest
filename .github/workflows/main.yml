name: API Automation CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  api-test:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 파이썬 환경 설정
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. 필요한 라이브러리 설치
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests pytest-html

      # 4. Pytest 실행 및 HTML 리포트 생성
      - name: Run API Tests
        run: |
          mkdir -p results
          # report.html을 생성하고 index.html로 복사하여 접속을 편하게 함
          pytest api_tests/ --html=results/index.html --self-contained-html || true

      # 5. GitHub Pages에 리포트 배포
      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./results
